<?php
	include_once('php/config.php');
	include_once("php/validate.php");
	include_once("php/general-session-variable.php");
	include_once("php/general-functions.php");
?>

<!DOCTYPE html>
<html lang="en">
	<head>
		<meta name="viewport" charset="UTF-8" content="width=device-width, initial-scale=1.0"/>
		<title>Admin Panel - IT Sales and Services Website</title>
		<link rel="icon" href="images/logo-monodark.png">
		<link rel="stylesheet" href="styles/header.css" media="all">
		<link rel="stylesheet" href="styles/general.css" media="all">
		<link rel="stylesheet" href="styles/footer-part.css" media="all">
		<link rel="stylesheet" href="styles/admin-panel.css" media="all">
		<link rel="stylesheet" href="styles/login.css" media="all">
	</head>
	<body class="body <?= htmlspecialchars($_SESSION['colorscheme']) ?>">
<?php
	if (isset($_SESSION["current_user"]) && $_SESSION["current_user"] === "admin") {
		include_once("php/header.php");
		echo "<h2 class='admin-welcome'>Ram Ram Admin!</h2>";
?>
<?php
	// }
?>
		<main class="main">
			<fieldset class="admin-fieldset">
				<legend class="admin-legend">
					<h3 class="admin-legend-head">
						Add New Product
					</h3>			
				</legend>
				<form action="<?=htmlspecialchars($_SERVER["PHP_SELF"])?>" class="product-form admin-form" method="POST" enctype="multipart/form-data">
					<div class="input-container">
						<div class="admin-label">Products name: </div>
						<input id="product-name" min="5" pattern="[A-Za-z0-9\-_ ]*" class="product-insert-input" placeholder="Enter Name" type="text" name="product-name" required>
					</div>
					<div class="input-container">
						<div class="admin-label">Product Short Description: </div>
						<textarea id="product-sdesc" min="5" rows="3" class="product-insert-input admin-textarea" name="product-sdesc" placeholder="Enter Short Description about Product" required></textarea>
					</div>
					<div class="input-container">
						<div class="admin-label">Product Long Description: </div>
						<textarea id="product-ldesc" min="5" rows="6" class="product-insert-input admin-textarea" name="product-ldesc" placeholder="Enter Long Description about Product" required></textarea>
					</div>
					<div class="input-container">
						<div class="admin-label">Product Stock: </div>
						<input id="product-stock" min="1" max="10000" placeholder="Enter Available Stock" class="product-insert-input" type="number" name="product-stock" required>
					</div>
					<div class="input-container">
						<div class="admin-label">Product Image: </div>
						<input id="product-image" class="product-insert-input" type="file" name="product-image" required>
					</div>
<?php 
	if (isset($_POST["submit"]) && $_POST["product-name"] != $_SESSION['sproduct_name']) {
		echo "post and no already same product";
		if($_SERVER["REQUEST_METHOD"] === "POST") {
			try {
				$check_product_exist_sql = "select product_name from products where product_name = \"".$_POST["product-name"]."\";";
				if ($check_product_exist = $conn->query($check_product_exist_sql)) {
					echo "<!--query true-->";
					echo "<br>";
				} else {
					echo "<!--query false-->";
					echo "<br>";
				}

				$product_exist_status = "false";
				if ($check_product_exist->num_rows > 0) {
					while ($row = $check_product_exist->fetch_assoc()) {
						// echo "while loop running....";
						if ($row["product_name"] == clean_input($_POST['product-name'])) {
							global $product_exist_status;
							$product_exist_status = "true";
							// echo "After Check: $product_exist_status";
							break;
						}
					}
				}

			} catch (Exception $err) {
				echo "<b><div class='php-status-error-message'>Server Side Error: Error in processing query</div><br></b>";
				// echo "<br>Error: <pre class='php-status-error-message'>$err</pre>";
			}

			if ($product_exist_status === "false") {

				// Handling Product details from POST
				$_SESSION['sproduct_name'] = clean_input($_POST["product-name"]);
				$_SESSION['sproduct_sdesc'] = clean_input($_POST["product-sdesc"]);
				$_SESSION['sproduct_ldesc'] = clean_input($_POST["product-ldesc"]);
				$_SESSION['sproduct_stock'] = clean_input($_POST["product-stock"]);

				// Handling Product image upload from POST
				$image_got = 0;
				if (isset($_FILES["product-name"])) {
					$image_dir = "images/products/";
					$image_name = $image_dir . basename($_FILES["product-image"]["name"]);
					$image_type = strtolower(pathinfo($image_name,PATHINFO_EXTENSION));
					echo "Image Directory: $image_dir";
					echo "Image name: $image_name";
					echo "Image Upload Status: $image_upload_status";
					echo "Image type: $image_type";

					// Check if image file is a actual image or fake image
					$check_if_image = getimagesize($_FILES["product-image"]);
					if ($check_if_image !== false) {
						echo "File is Image - " . $check_if_image["mime"] . ".";
					} else {
						echo "File is not an image.";
					}
					$_SESSION['sproduct_imagepath'] = $image_name;
					$image_got = 1;
				}

				try {
					$stmt = $conn->prepare("INSERT INTO products (product_name, product_shortdesc, product_longdesc, product_stock, product_imagepath) VALUES (?, ?, ?, ?, ?)");
					$stmt->bind_param("ssss", $_SESSION['sproduct_name'], $_SESSION['sproduct_sdesc'], $_SESSION['sproduct_ldesc'], $_SESSION['sproduct_stock']);
					$stmt->execute(); // Uploaded Data
					if ($image_got) {
						move_uploaded_file($imagename, $image_dir);
					}

					$sql_id_get = "select max(product_id) from products;";
					$result = $conn->query($sql_id_get);

					if ($result->num_rows > 0) {
						// output data of each row
						while($row = $result->fetch_assoc()) {
							$_SESSION["lastinsert_id"] = $row["max(product_id)"];
						}
					} else {
						echo "0 results";
					}
					unset ($_POST["product-name"]);
					echo "<div class='php-status-message'>";
					echo "New Product added successfully with product id ". $_SESSION["lastinsert_id"];
					echo "</div>";
				} catch (Exception $err) {
					echo "Error: " . $sql . "<br>" . $conn->error;
				}
			} else {
				echo "<div class='php-status-error-message'>";
				echo "Product With Same Name Already Exists";
				echo "</div>";
			}
		}
	}
?>
					<div class="input-container admin-btn-container">
						<input type="submit" class="login-btn admin-btn submit admin-btn-green" value="Add New Product To Database">
						<input type="reset" class="login-btn admin-btn reset admin-btn-red" value="Reset Fields">
					</div>
				</form>
			</fieldset>
		</main>
<?php
	include_once("php/footer.php");
?>
<?php
} else {
	header("Location: login.html");
	exit();
?>
		<meta http-equiv="refresh" content="0; url=noscript.html" /> <!-- Fallback, in whatever case above doesn't work  -->
<?php
}
?>
		<script src="scripts/base.js"></script>
	</body>
</html>
