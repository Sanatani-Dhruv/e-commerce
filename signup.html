<?php
	include_once("php/config.php");
	include_once("php/validate.php");
	include_once("php/general-session-variable.php");
	include_once("php/general-functions.php");
?>
<?php
// if (isset($_POST['login_name']) && isset($_SERVER['REQUEST_URI']))
// {
//     // [process the post data in 'mypostvar']
//     header ('Location: ' . $_SERVER['REQUEST_URI']);
//     exit();
// }
?>
<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Sign Up - IT Sales and Services Website</title>
		<link rel="icon" href="images/logo-monodark.png">
		<link rel="stylesheet" href="styles/header.css" media="all">
		<link rel="stylesheet" href="styles/general.css" media="all">
		<link rel="stylesheet" href="styles/view-page.css" media="all">
		<link rel="stylesheet" href="styles/info-page.css" media="all">
		<link rel="stylesheet" href="styles/footer-part.css" media="all">
		<link rel="stylesheet" href="styles/login.css" media="all">
	</head>
	<body class="body <?= htmlspecialchars($_SESSION['colorscheme']) ?>">
<?php
	include_once("php/header.php");
?>
		<main class="main-container">
			<div class="login-container-box">
				<h2 class="login-title">
					Sign Up your Account
				</h2>
				<form method="post" action='<?=htmlspecialchars($_SERVER["PHP_SELF"])?>'>
					<div class="login-container">
						<div class="login-input-container">
							<label class="login-label" for="login-name">User Name: </label>
							<input class="login-input" pattern="[a-z0-9 ]*" id="login-name" type="text" placeholder="Enter User Name" name="login-name" required>
						</div>
						<div class="login-input-container">
							<label class="login-label" for="login-email">Email: </label>
							<input class="login-input" pattern="([a-z0-9].{5,25})[@]([a-z0-9].{2,10})\.([a-z].{1,10})" id="login-email" type="email" placeholder="Enter Your Email" title="Example: example123@kmail.com" name="login-email" required>
						</div>
						<div class="login-input-container">
							<label class="login-label" for="login-number">Number: </label>
							<input class="login-input" id="login-number" type="tel" placeholder="Enter Your Mobile Number" name="login-number" required>
						</div>
						<div class="login-input-container">
							<label class="login-label" for="login-password">Password: </label>
							<input class="login-input" id="login-password" type="password" placeholder="Enter Your Password" name="login-password" required>
						</div>
<?php 
// echo ($_SESSION['slogin_name']);
if (isset($_POST["submit"]) && $_POST["login-name"] != $_SESSION['slogin_name']) {
	// unset ($_SESSION['slogin_name']);
	// 	header("Location:". $_SERVER['PHP_SELF']);
	// 	exit();
	// echo "<br>else Block<br>";
	if ($_SERVER['REQUEST_METHOD'] === 'POST') {
		// echo "req-meth: POST";
		try {
			// echo "<br>This is try block<br>";
			$check_user_exist_sql = "select user_name from users where user_name = \"".$_POST['login-name']."\";";
			if ($check_user_exist = $conn->query($check_user_exist_sql)) {
				echo "<!--query true-->";
			} else {
				// echo "<br>";
				echo "<!--query false-->";
				// echo "<br>";
			}
			// $check_user_exist = $conn->query($check_user_exist_sql);
			// echo "<br>";
			// echo $check_user_exist_sql;
			// echo "<br>";
			// echo "<br>";
			// echo "Query Ok!";
			// echo "<br>";
			$user_exist_status = "false";
			// echo "<br>";
			// echo "Before Check: $user_exist_status";
			// echo "<br>";
			if ($check_user_exist->num_rows > 0) {
				while ($row = $check_user_exist->fetch_assoc()) {
					// echo "while loop running....";
					if ($row["user_name"] == clean_input($_POST['login-name'])) {
						global $user_exist_status;
						$user_exist_status = "true";
						// echo "After Check: $user_exist_status";
						break;
					}
				}
			}
		} catch (Exception $err) {
			echo "<br>Error: <pre class='php-status-error-message'>$err</pre>";
		}
		if ($user_exist_status === "false") {
			$_SESSION['slogin_name'] = clean_input($_POST["login-name"]);
			$_SESSION['slogin_email'] = clean_input($_POST["login-email"]);
			$_SESSION['slogin_number'] = clean_input($_POST["login-number"]);
			$_SESSION['slogin_password'] = clean_input($_POST["login-password"]);
			$_SESSION['slogin_password'] = password_hash($_SESSION["slogin_password"], PASSWORD_DEFAULT);
			// echo $_SESSION['slogin_password'];

			// header("Location: login.html");
			// echo "NAME: $login_name<br> EMAIL: $login_mail<br> NUMBER: $login_number<br> PASSWD: $login_passwd<br>";
			try{ 
				$stmt = $conn->prepare("INSERT INTO users (user_name, user_email, user_number, user_pass) VALUES (?, ?, ?, ?);");
				$stmt->bind_param("ssss", $_SESSION['slogin_name'], $_SESSION['slogin_email'], $_SESSION['slogin_number'], $_SESSION['slogin_password']);
				$stmt->execute();
				$sql_id_get = "select max(user_id) from users;";
				$result = $conn->query($sql_id_get);

				if ($result->num_rows > 0) {
					// output data of each row
					while($row = $result->fetch_assoc()) {
						$_SESSION["lastinsert_id"] = $row["max(user_id)"];
					}
				} else {
					echo "0 results";
				}
				unset ($_POST["login_name"]);
				echo "<div class='php-status-message'>";
				echo "New Account created successfully with user id ". $_SESSION["lastinsert_id"];
				echo "</div>";
			} catch (Exception $err) {
				echo "Error: " . $sql . "<br>" . $conn->error;
			}
		} else {
			echo "<div class='php-status-error-message'>";
			echo "User With Same Name Already Exists";
			echo "</div>";
		}
		// exit();
	}
} else {
	// header("Location:". $_SERVER['PHP_SELF']);
	// header("Location:". $_SERVER['PHP_SELF']);
	// exit();
}
?>
						<div class="login-input-container">
							<input class="login-btn submit" name="submit" type="submit" value="Sign Up">
							<input class="login-btn reset" name="reset" type="reset" value="Reset">
						</div>
					</div>
				</form>
			</div>
		</main>
<?php
	include_once("php/footer.php");
?>
		<script src="scripts/base.js"></script>
	</body>
</html>
<?php
// $stmt->close();
$conn->close();
?>
